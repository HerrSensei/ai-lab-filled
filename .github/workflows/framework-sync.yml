name: Framework Sync and Deploy

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/ai_lab_framework/**'
      - 'core/templates/**'
      - 'data/schemas/**'
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Target repositories'
        required: true
        default: 'ai-lab,ai-lab-filled'
        type: string
      sync_type:
        description: 'Sync type'
        required: true
        default: 'framework'
        type: choice
        options:
          - framework
          - templates
          - schemas
          - all

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      framework-changed: ${{ steps.changes.outputs.framework }}
      templates-changed: ${{ steps.changes.outputs.templates }}
      schemas-changed: ${{ steps.changes.outputs.schemas }}
      docs-changed: ${{ steps.changes.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for file changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "framework=true" >> $GITHUB_OUTPUT
            echo "templates=true" >> $GITHUB_OUTPUT
            echo "schemas=true" >> $GITHUB_OUTPUT
            echo "docs=true" >> $GITHUB_OUTPUT
          else
            echo "framework=$(git diff --name-only HEAD~1 HEAD | grep -q 'src/ai_lab_framework/' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "templates=$(git diff --name-only HEAD~1 HEAD | grep -q 'core/templates/' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "schemas=$(git diff --name-only HEAD~1 HEAD | grep -q 'data/schemas/' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "docs=$(git diff --name-only HEAD~1 HEAD | grep -q '\.md$' && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

  deploy-to-ai-lab:
    needs: detect-changes
    if: needs.detect-changes.outputs.framework-changed == 'true' || needs.detect-changes.outputs.templates-changed == 'true' || needs.detect-changes.outputs.schemas-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ai-lab
        uses: actions/checkout@v4
        with:
          repository: HerrSensei/ai-lab
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch
        run: |
          BRANCH_NAME="sync/framework-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Sync framework changes
        run: |
          # Add remote for this repository
          git remote add source https://github.com/HerrSensei/ai-lab-framework.git
          git fetch source main
          
          # Sync framework files
          if [ "${{ needs.detect-changes.outputs.framework-changed }}" == "true" ] || [ "${{ github.event.inputs.sync_type }}" = "framework" ] || [ "${{ github.event.inputs.sync_type }}" = "all" ]; then
            echo "Syncing framework files..."
            git checkout source/main -- src/ai_lab_framework/
          fi
          
          # Sync template files
          if [ "${{ needs.detect-changes.outputs.templates-changed }}" == "true" ] || [ "${{ github.event.inputs.sync_type }}" = "templates" ] || [ "${{ github.event.inputs.sync_type }}" = "all" ]; then
            echo "Syncing template files..."
            git checkout source/main -- core/templates/
          fi
          
          # Sync schema files
          if [ "${{ needs.detect-changes.outputs.schemas-changed }}" == "true" ] || [ "${{ github.event.inputs.sync_type }}" = "schemas" ] || [ "${{ github.event.inputs.sync_type }}" = "all" ]; then
            echo "Syncing schema files..."
            git checkout source/main -- data/schemas/
          fi

      - name: Commit and push changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Sync framework changes from ai-lab-framework

- Sync framework core files
- Sync template files  
- Sync schema files
- Automated sync from ${{ github.sha }}

[skip ci]"
            git push origin "$BRANCH_NAME"
            
            # Create pull request
            gh pr create \
              --title "chore: Sync framework changes from ai-lab-framework" \
              --body "Automated sync of framework changes from ai-lab-framework

**Changes:**
- Framework core files updated
- Template files updated
- Schema files updated

**Commit:** ${{ github.sha }}

This PR was created automatically by the Framework Sync workflow." \
              --base main \
              --head "$BRANCH_NAME"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-ai-lab-filled:
    needs: detect-changes
    if: needs.detect-changes.outputs.framework-changed == 'true' || needs.detect-changes.outputs.templates-changed == 'true' || needs.detect-changes.outputs.schemas-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ai-lab-filled
        uses: actions/checkout@v4
        with:
          repository: HerrSensei/ai-lab-filled
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch
        run: |
          BRANCH_NAME="sync/framework-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Sync framework changes
        run: |
          # Add remote for this repository
          git remote add source https://github.com/HerrSensei/ai-lab-framework.git
          git fetch source main
          
          # Sync framework files
          if [ "${{ needs.detect-changes.outputs.framework-changed }}" == "true" ] || [ "${{ github.event.inputs.sync_type }}" = "framework" ] || [ "${{ github.event.inputs.sync_type }}" = "all" ]; then
            echo "Syncing framework files..."
            git checkout source/main -- src/ai_lab_framework/
          fi
          
          # Sync template files
          if [ "${{ needs.detect-changes.outputs.templates-changed }}" == "true" ] || [ "${{ github.event.inputs.sync_type }}" = "templates" ] || [ "${{ github.event.inputs.sync_type }}" = "all" ]; then
            echo "Syncing template files..."
            git checkout source/main -- core/templates/
          fi
          
          # Sync schema files
          if [ "${{ needs.detect-changes.outputs.schemas-changed }}" == "true" ] || [ "${{ github.event.inputs.sync_type }}" = "schemas" ] || [ "${{ github.event.inputs.sync_type }}" = "all" ]; then
            echo "Syncing schema files..."
            git checkout source/main -- data/schemas/
          fi

      - name: Commit and push changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Sync framework changes from ai-lab-framework

- Sync framework core files
- Sync template files  
- Sync schema files
- Automated sync from ${{ github.sha }}

[skip ci]"
            git push origin "$BRANCH_NAME"
            
            # Create pull request
            gh pr create \
              --title "chore: Sync framework changes from ai-lab-framework" \
              --body "Automated sync of framework changes from ai-lab-framework

**Changes:**
- Framework core files updated
- Template files updated
- Schema files updated

**Commit:** ${{ github.sha }}

This PR was created automatically by the Framework Sync workflow." \
              --base main \
              --head "$BRANCH_NAME"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    needs: [deploy-to-ai-lab, deploy-to-ai-lab-filled]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify completion
        run: |
          echo "Framework sync completed!"
          echo "ai-lab deployment: ${{ needs.deploy-to-ai-lab.result }}"
          echo "ai-lab-filled deployment: ${{ needs.deploy-to-ai-lab-filled.result }}"