name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff mypy pytest

      - name: Run Black
        run: black --check --diff .

      - name: Run Ruff
        run: ruff check .

      - name: Run MyPy
        run: mypy src/ || true  # Allow mypy to fail for now

  test:
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov playwright

      - name: Install Playwright browsers
        run: playwright install --with-deps

      - name: Run tests
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  build-and-validate:
    runs-on: ubuntu-latest
    needs: [lint-and-format, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Validate schemas
        run: |
          python -c "
          import json
          import jsonschema
          from pathlib import Path

          schemas_dir = Path('data/schemas')
          for schema_file in schemas_dir.glob('*.json'):
              print(f'Validating {schema_file.name}...')
              with open(schema_file) as f:
                  schema = json.load(f)
              jsonschema.Draft7Validator.check_schema(schema)
              print('‚úÖ Valid')
          "

      - name: Test framework import
        run: |
          python -c "
          try:
              from ai_lab_framework import BaseAITool, ProfileManager
              print('‚úÖ Framework imports successfully')
          except ImportError as e:
              print(f'‚ùå Import error: {e}')
              exit(1)
          "

      - name: Test templates
        run: |
          python -c "
          from pathlib import Path
          import yaml

          templates_dir = Path('core/templates')
          for yaml_file in templates_dir.rglob('*.yaml'):
              print(f'Validating {yaml_file.relative_to(templates_dir)}...')
              with open(yaml_file) as f:
                  yaml.safe_load(f)
              print('‚úÖ Valid')
          "

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [lint-and-format, test, build-and-validate]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          # Add staging deployment commands here

  notify-success:
    needs: [lint-and-format, test, security-scan, build-and-validate]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Notify success
        run: |
          echo "‚úÖ All CI/CD checks passed successfully!"
          echo "üìä Metrics:"
          echo "  - Linting: ‚úÖ"
          echo "  - Testing: ‚úÖ"
          echo "  - Security: ‚úÖ"
          echo "  - Build: ‚úÖ"

  notify-failure:
    needs: [lint-and-format, test, security-scan, build-and-validate]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify failure
        run: |
          echo "‚ùå CI/CD pipeline failed!"
          echo "üîç Check the failed jobs above for details"
          echo "üìä Failed jobs:"
          echo "  - Linting: ${{ needs.lint-and-format.result }}"
          echo "  - Testing: ${{ needs.test.result }}"
          echo "  - Security: ${{ needs.security-scan.result }}"
          echo "  - Build: ${{ needs.build-and-validate.result }}"