"""
Integration tests for the API.

This module tests the integration between different components
and the overall API functionality.
"""

import pytest
from fastapi.testclient import TestClient


class TestAPIIntegration:
    """Integration tests for the API."""

    def test_full_chat_flow(self, client: TestClient):
        """Test complete chat flow from request to response."""
        # This would test the actual flow with mocked AI service
        # For now, just test the endpoint structure
        response = client.get("/api/v1/chat/models")
        assert response.status_code == 200

        models = response.json()
        assert len(models["available"]) > 0

        # Test with first available model
        first_model = models["available"][0]["id"]

        chat_request = {
            "message": "Hello, this is a test message",
            "model": first_model,
            "temperature": 0.7,
            "max_tokens": 50,
        }

        # This would normally succeed but will fail without proper AI service setup
        # In a real test, you'd mock the AI service
        response = client.post("/api/v1/chat/", json=chat_request)
        # Expected to fail without proper setup, but structure should be correct
        assert response.status_code in [200, 500, 502]

    def test_health_check_integration(self, client: TestClient):
        """Test health check integration."""
        # Basic health check
        response = client.get("/health")
        assert response.status_code == 200

        # Detailed health check
        response = client.get("/api/v1/health/detailed")
        assert response.status_code == 200

        data = response.json()
        assert "status" in data
        assert "checks" in data
        assert "application" in data["checks"]
        assert "ai_service" in data["checks"]
        assert "configuration" in data["checks"]

    def test_error_handling_integration(self, client: TestClient):
        """Test error handling across the API."""
        # Test 404 for non-existent endpoint
        response = client.get("/api/v1/nonexistent")
        assert response.status_code == 404

        # Test validation error
        response = client.post("/api/v1/chat/", json={})
        assert response.status_code == 422

        data = response.json()
        assert "detail" in data

    def test_cors_integration(self, client: TestClient):
        """Test CORS integration."""
        # Test preflight request
        response = client.options(
            "/api/v1/chat/",
            headers={
                "Origin": "http://localhost:3000",
                "Access-Control-Request-Method": "POST",
                "Access-Control-Request-Headers": "Content-Type",
            }
        )

        assert response.status_code == 200
        assert "access-control-allow-origin" in response.headers
